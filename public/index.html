<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>常见鸟类辨识图鉴</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#111111',
                        secondary: '#303030',
                        neutral: '#e5e7eb',
                        dark: '#212529'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }

            .card-hover {
                @apply transition-all duration-300 hover:shadow-xl hover:-translate-y-1;
            }

            .btn-primary {
                @apply bg-primary hover:bg-secondary text-white font-medium py-2 px-4 transition-all duration-300;
            }

            .btn-outline {
                @apply border border-primary text-primary hover:bg-primary hover:text-white font-medium py-2 px-4 transition-all duration-300;
            }

            /* 强制每行4列的网格布局 */
            .gallery-fixed-cols {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-dark min-h-screen flex flex-col">
<!-- 导航栏 -->
<header class="bg-white border-b-2 border-black p-4 fixed w-full z-50 transition-all duration-300" id="navbar">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <i class="fa fa-dove text-primary text-5xl"></i>
            <h1 class="text-lg md:text-2xl lg:text-3xl font-bold text-primary">常见鸟类辨识图鉴</h1>
        </div>
        <button id="add-bird-btn" class="btn-primary flex items-center">
            <i class="fa fa-plus mr-2"></i>添加
        </button>
    </div>
</header>

<!-- 主内容区 -->
<main class="container mx-auto px-4 pt-24 pb-16 flex-grow">

    <!-- 鸟类统计 -->
    <div class="mb-4 mt-4 flex flex-row gap-[12px]">
        <div class="bg-white border-2 border-black p-4 p-6 flex items-center flex-1">
            <div class="w-12 h-12 bg-primary/10 flex items-center justify-center mr-4">
                <i class="fa fa-database text-primary text-xl"></i>
            </div>
            <div>
                <p class="text-gray-500 text-sm">
                    <span class="inline-block md:hidden">已收录</span>
                    <span class="hidden md:inline">已收录</span>
                    <br class="md:hidden">鸟类
                </p>
                <p class="text-2xl font-bold" id="bird-count">0</p>
            </div>
        </div>
        <div class="bg-white border-2 border-black p-4 p-6 flex items-center flex-1">
            <div class="w-12 h-12 bg-secondary/10 flex items-center justify-center mr-4">
                <i class="fa fa-image text-secondary text-xl"></i>
            </div>
            <div>
                <p class="text-gray-500 text-sm">
                    <span class="inline-block md:hidden">已收录</span>
                    <span class="hidden md:inline">已收录</span>
                    <br class="md:hidden">图片
                </p>
                <p class="text-2xl font-bold" id="image-count">0</p>
            </div>
        </div>
    </div>

    <!-- 搜索 -->
    <div class="bg-white border-2 border-black p-4 p-6 mb-8 md:mb-16">
        <div class="relative w-full">
            <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            <input type="text" id="search-input" placeholder="搜索鸟类名称..."
                   class="w-full pl-10 pr-4 py-2 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/50">
        </div>
    </div>

    <!-- 鸟类画廊 -->
    <div id="bird-gallery" class="grid gallery-fixed-cols gap-1 md:gap-8">
        <!-- 鸟类卡片将通过JavaScript动态生成 -->
        <div class="col-span-full text-center py-12">
            <div class="inline-block animate-spin h-12 w-12 border-b-2 border-primary"></div>
            <p class="text-gray-500 mt-4">加载鸟类数据中...</p>
        </div>
    </div>

    <!-- 加载更多 -->
    <div class="mt-12 text-center">
        <button id="load-more" class="btn-primary px-8">
            <i class="fa fa-refresh mr-2"></i>加载更多
        </button>
    </div>
</main>

<!-- 添加/编辑鸟类模态框 -->
<div id="bird-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white shadow-2xl w-full max-w-lg mx-4 transform transition-all duration-300 scale-95 opacity-0"
         id="modal-content">
        <div class="flex justify-between items-center p-6 border-b">
            <h2 class="text-xl font-bold text-primary" id="modal-title">上传夜鹭拟态图鉴</h2>
            <button id="close-modal" class="text-gray-400 hover:text-gray-600">
                <i class="fa fa-times text-xl"></i>
            </button>
        </div>
        <div class="p-6">
            <form id="bird-form" enctype="multipart/form-data">
                <input type="hidden" id="bird-id" name="bird-id">
                <div class="mb-4">
                    <label for="bird-name" class="block text-sm font-medium text-gray-700 mb-1">名称（10个字以内）</label>
                    <input type="text" id="bird-name" name="bird-name" placeholder="输入鸟类名称"
                           class="w-full px-4 py-2 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/50">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">图片（越包浆越有味）</label>
                    <div class="border-2 border-dashed border-gray-300 p-6 text-center cursor-pointer hover:bg-gray-50 transition-colors"
                         id="image-upload-area">
                        <input type="file" id="bird-image" name="bird-image" accept="image/*" class="hidden">
                        <i class="fa fa-cloud-upload text-gray-400 text-3xl mb-2"></i>
                        <p class="text-gray-500 mb-1">点击或拖拽图片到这里上传</p>
                        <p class="text-xs text-gray-400">支持 JPG, PNG 格式，最大 1MB</p>
                    </div>
                    <div id="image-preview-container" class="hidden mt-3">
                        <img id="image-preview" src="" alt="预览图" class="w-full h-40 object-cover">
                        <button type="button" id="remove-image" class="mt-2 text-red-500 text-sm hover:text-red-700">
                            <i class="fa fa-trash-o mr-1"></i>移除图片
                        </button>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-bird" class="btn-outline">取消</button>
                    <button type="submit" class="btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 页脚 -->
<footer class="text-black py-2 border-t-2 border-black">
    <div class="container mx-auto px-2">
        <div class="flex flex-col items-center justify-center">
            <div class="mt-1 mb-4 text-center">
                <button id="about-btn" class="text-black hover:text-gray-500 transition-colors flex items-center mx-auto text-xl font-bold">
                    <i class="fa fa-info-circle mr-1"></i> 关于
                </button>
                <a href="https://space.bilibili.com/29602970" class="underline block mt-4 text-black hover:text-gray-500 transition-colors flex">联系开发者</a>
            </div>
        </div>
    </div>
</footer>

<!-- 关于模态框 -->
<div id="about-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white shadow-2xl w-full max-w-lg mx-4 transform transition-all duration-300 scale-95 opacity-0"
         id="about-modal-content">
        <div class="flex justify-between items-center p-6 border-b">
            <h2 class="text-xl font-bold text-primary">关于本网站</h2>
            <button id="close-about-modal" class="text-gray-400 hover:text-gray-600">
                <i class="fa fa-times text-xl"></i>
            </button>
        </div>
        <div class="p-6">
            <p>
                本网站灵感来源于“夜鹭拟态图鉴”，
                图片来自各大社群与用户上传。<br>
                简单而言，这里你看到的所有“夜鹭”
                都不是夜鹭，而其它的都是夜鹭。<br>
                <a href="https://space.bilibili.com/29602970" class="text-l font-bold underline">点击此处联系开发者</a>
            </p>
        </div>
        <div class="p-6 border-t">
            <div class="flex justify-end">
                <button id="close-about-btn" class="btn-primary">
                    关闭
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 通知组件 -->
<div id="notification"
     class="fixed bottom-4 right-4 bg-primary text-white px-4 py-2 border-2 border-black p-4 transform transition-all duration-500 translate-y-20 opacity-0 z-50"></div>

<script>
    window.isServiceWorkerEnabled = false; // 全局标志，默认禁用

    // 注册 Service Worker
    // if ('serviceWorker' in navigator) {
    //     window.addEventListener('load', () => {
    //         navigator.serviceWorker.register('/sw.js')
    //             .then(registration => {
    //                 console.log('SW registered:', registration);
    //                 window.isServiceWorkerEnabled = true; // 注册成功，启用缓存
    //             })
    //             .catch(error => {
    //                 console.log('SW registration failed:', error);
    //                 // 注册失败时清除可能存在的旧缓存
    //                 if ('caches' in window) {
    //                     caches.keys().then(cacheNames => {
    //                         return Promise.all(
    //                             cacheNames.map(cacheName => {
    //                                 return caches.delete(cacheName);
    //                             })
    //                         );
    //                     });
    //                 }
    //                 window.isServiceWorkerEnabled = false; // 禁用缓存
    //             });
    //     });
    // }

    // API配置
    // 根据当前域名动态设置 API 基础 URL
    const API_BASE_URL = (() => {
        // 开发环境使用 localhost
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            return 'http://localhost:3000/api';
        }
        // 生产环境使用当前域名
        return `${window.location.protocol}//${window.location.host}/api`;
    })();
    const CACHE_NAME = 'bird-guide-cache-v3';
    const CACHE_EXPIRATION_DAYS = 7; // 缓存过期天数
    let currentBirdId = null; // 当前操作的鸟类ID
    let currentPage = 1;
    let isLoading = false;
    let hasMoreData = true;

    // DOM 元素
    const addBirdBtn = document.getElementById('add-bird-btn');
    const birdModal = document.getElementById('bird-modal');
    const modalContent = document.getElementById('modal-content');
    const closeModal = document.getElementById('close-modal');
    const cancelBird = document.getElementById('cancel-bird');
    const birdForm = document.getElementById('bird-form');
    const birdIdInput = document.getElementById('bird-id');
    const birdNameInput = document.getElementById('bird-name');
    const birdImageInput = document.getElementById('bird-image');
    const imageUploadArea = document.getElementById('image-upload-area');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const imagePreview = document.getElementById('image-preview');
    const removeImageBtn = document.getElementById('remove-image');
    const birdGallery = document.getElementById('bird-gallery');
    const birdCountElement = document.getElementById('bird-count');
    const imageCountElement = document.getElementById('image-count');
    const navbar = document.getElementById('navbar');
    const searchInput = document.getElementById('search-input');
    const loadMoreBtn = document.getElementById('load-more');
    const notification = document.getElementById('notification');
    const modalTitle = document.getElementById('modal-title');
    // 关于模态框控制
    const aboutBtn = document.getElementById('about-btn');
    const aboutModal = document.getElementById('about-modal');
    const aboutModalContent = document.getElementById('about-modal-content');
    const closeAboutModal = document.getElementById('close-about-modal');
    const closeAboutBtn = document.getElementById('close-about-btn');

    // 打开关于模态框
    aboutBtn.addEventListener('click', () => {
        aboutModal.classList.remove('hidden');
        setTimeout(() => {
            aboutModalContent.classList.remove('scale-95', 'opacity-0');
            aboutModalContent.classList.add('scale-100', 'opacity-100');
        }, 10);
    });

    // 关闭关于模态框
    function closeAbout() {
        aboutModalContent.classList.remove('scale-100', 'opacity-100');
        aboutModalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            aboutModal.classList.add('hidden');
        }, 300);
    }

    closeAboutModal.addEventListener('click', closeAbout);
    closeAboutBtn.addEventListener('click', closeAbout);

    // 点击模态框外部关闭
    aboutModal.addEventListener('click', (e) => {
        if (e.target === aboutModal) {
            closeAbout();
        }
    });

    // 初始化页面
    function init() {
        setupEventListeners();
        initCache().then(() => {
            fetchBirds();
            fetchBirdCount();
        });
    }

    // 防抖函数
    function debounce(func, delay) {
        let timeout;
        return function() {
            const context = this;
            const args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    // 优化后的防抖函数（带输入长度判断）
    function debounceSearch(func, delay) {
        let timeout;
        return function() {
            const context = this;
            const args = arguments;
            const inputValue = this.value.trim(); // 获取输入框的值

            // 清除之前的定时器
            clearTimeout(timeout);

            // 如果输入框为空或已达到最小搜索长度，立即执行搜索
            if (inputValue.length === 0 || inputValue.length >= 1) {
                timeout = setTimeout(() => func.apply(context, args), delay);
            }
        };
    }

    document.addEventListener('DOMContentLoaded', () => {
        // 全局变量，指示是否为管理员
        window.isAdmin = false;

        const searchInput = document.getElementById('search-input');
        const searchDebounced = debounceSearch(() => {
            const searchTerm = searchInput.value.trim();
            if (searchTerm === '') {
                // 内容为空时重置搜索（显示全部鸟类）
                fetchBirds(1, '');
                return;
            }
            // 执行搜索逻辑
            fetchBirds(1, searchTerm);
        }, 750); // 延时750ms执行搜索

        // 监听输入框内容变化
        searchInput.addEventListener('input', searchDebounced);
    });

    // 在 init() 函数中添加缓存初始化
    async function initCache() {
        if (!window.isServiceWorkerEnabled) return; // 如果SW未启用，跳过缓存初始化

        if ('caches' in window) {
            try {
                const cache = await caches.open(CACHE_NAME);
                await cleanupExpiredCache();
            } catch (error) {
                console.error('Cache initialization failed:', error);
            }
        }
    }

    // 清理过期缓存
    async function cleanupExpiredCache() {
        if (!window.isServiceWorkerEnabled) return; // 如果SW未启用，跳过缓存清理

        try {
            const cacheNames = await caches.keys();
            const currentTime = Date.now();

            for (const name of cacheNames) {
                if (name !== CACHE_NAME) {
                    await caches.delete(name);
                }
            }

            // 检查当前缓存是否过期
            const cache = await caches.open(CACHE_NAME);
            const response = await cache.match(`${API_BASE_URL}/birds?cache_meta=1`);

            if (response) {
                const data = await response.json();
                const cacheTime = new Date(data.cacheTime).getTime();
                const expirationTime = cacheTime + (CACHE_EXPIRATION_DAYS * 24 * 60 * 60 * 1000);

                if (currentTime > expirationTime) {
                    await caches.delete(CACHE_NAME);
                    console.log('Expired cache deleted');
                }
            }
        } catch (error) {
            console.error('Cache cleanup failed:', error);
        }
    }

    // 设置事件监听器
    function setupEventListeners() {
        // 添加鸟类按钮点击事件
        addBirdBtn.addEventListener('click', () => openBirdModal('add'));

        // 关闭模态框按钮点击事件
        closeModal.addEventListener('click', closeBirdModal);
        cancelBird.addEventListener('click', closeBirdModal);

        // 鸟类表单提交事件
        birdForm.addEventListener('submit', handleBirdFormSubmit);

        // 图片上传区域点击事件
        imageUploadArea.addEventListener('click', () => birdImageInput.click());

        // 图片选择事件
        birdImageInput.addEventListener('change', handleImageUpload);

        // 移除图片按钮点击事件
        removeImageBtn.addEventListener('click', removeImagePreview);

        // 滚动事件 - 导航栏样式变化
        window.addEventListener('scroll', handleScroll);

        // 搜索输入事件
        searchInput.addEventListener('input', handleSearch);

        // 加载更多按钮点击事件
        loadMoreBtn.addEventListener('click', loadMoreBirds);
    }

    // 获取鸟类列表
    async function fetchBirds(page = 1, searchTerm = '', checkAdmin = false) {
        if (isLoading || (!page && page !== 1)) return Promise.resolve();

        isLoading = true;

        let url = `${API_BASE_URL}/birds?page=${page}`;
        if (searchTerm) {
            url += `&search=${encodeURIComponent(searchTerm)}`;
        }

        // 仅在明确要求时检查管理员权限
        if (checkAdmin) {
            url += `&checkAdmin=true`;
        }

        if (page === 1) {
            birdGallery.innerHTML = `
        <div class="col-span-full text-center py-12">
            <div class="inline-block animate-spin h-12 w-12 border-b-2 border-primary"></div>
            <p class="text-gray-500 mt-4">加载鸟类数据中...</p>
        </div>
        `;
        }

        try {
            let response;

            // 根据isServiceWorkerEnabled决定请求方式
            if (window.isServiceWorkerEnabled) {
                // 使用缓存策略
                response = await fetchWithCache(url, forceRefresh);
            } else {
                // 直接从网络获取，不使用缓存
                response = await fetch(url, {
                    cache: 'no-store'
                });

                // 检查响应状态
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            }

            const data = await response.json();

            // 更新管理员状态
            if (data.isAdmin !== undefined) {
                window.isAdmin = data.isAdmin;
                updateAdminUI(); // 需要实现这个函数来更新UI显示
            }

            if (page === 1) {
                birdGallery.innerHTML = '';
            }

            if (data.birds.length === 0) {
                if (page === 1) {
                    birdGallery.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <i class="fa fa-search text-gray-400 text-4xl mb-4"></i>
                    <p class="text-gray-500">没有找到匹配的鸟类</p>
                </div>
                `;
                } else {
                    hasMoreData = false;
                    showNotification('没有更多数据了');
                    updateLoadMoreButton(false);
                }
                return;
            }

            data.birds.forEach(bird => {
                const birdCard = createBirdCard(bird);
                birdGallery.appendChild(birdCard);
            });

            currentPage = page;
            hasMoreData = data.hasMore;
            updateLoadMoreButton(data.hasMore);
        } catch (error) {
            console.error('Fetching birds failed:', error);

            // 如果是无缓存模式，直接显示错误信息
            if (!window.isServiceWorkerEnabled) {
                showNoDataMessage(page);
                showNotification('无法加载数据，请检查网络连接', 'error');
                return;
            }

            // 网络请求失败，尝试从缓存获取（仅在Service Worker启用时）
            try {
                const cache = await caches.open(CACHE_NAME);
                const cachedResponse = await cache.match(url);

                if (cachedResponse) {
                    showNotification('使用缓存数据，内容可能不是最新的', 'warning');

                    const data = await cachedResponse.json();

                    if (page === 1) {
                        birdGallery.innerHTML = '';
                    }

                    if (data.birds && data.birds.length > 0) {
                        data.birds.forEach(bird => {
                            const birdCard = createBirdCard(bird);
                            birdGallery.appendChild(birdCard);
                        });

                        currentPage = page;
                        hasMoreData = data.hasMore || false;
                        updateLoadMoreButton(data.hasMore || false);

                        // 添加刷新缓存按钮
                        if (page === 1) {
                            addRefreshCacheButton();
                        }
                    } else {
                        showNoDataMessage(page);
                    }
                } else {
                    showNoDataMessage(page);
                    throw new Error('No cached data available');
                }
            } catch (cacheError) {
                console.error('Cache fetch failed:', cacheError);
                showNoDataMessage(page);
                showNotification('无法加载数据，请检查网络连接', 'error');
            }
        } finally {
            isLoading = false;
        }
    }

    // 根据管理员状态更新UI的函数
    function updateAdminUI() {
        const adminControls = document.querySelectorAll('.admin-control');
        adminControls.forEach(el => {
            el.style.display = window.isAdmin ? 'block' : 'none';
        });

        if (window.isAdmin) {
            showNotification('已切换到管理员模式', 'success');
        }
    }

    // 辅助函数：显示无数据消息
    function showNoDataMessage(page) {
        if (page === 1) {
            birdGallery.innerHTML = `
        <div class="col-span-full text-center py-12">
            <i class="fa fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
            <p class="text-gray-500">无法加载数据，请检查网络连接</p>
            <button id="retry-load" class="btn-primary mt-4">
                <i class="fa fa-refresh mr-2"></i>重试
            </button>
        </div>
        `;

            document.getElementById('retry-load').addEventListener('click', () => {
                fetchBirds(1, searchInput.value.toLowerCase().trim(), true);
            });
        }
    }

    // 添加刷新缓存按钮
    function addRefreshCacheButton() {
        // 如果是无缓存模式，不显示刷新缓存按钮
        if (!window.isServiceWorkerEnabled) return;

        const existingRefreshBtn = document.getElementById('refresh-cache-btn');
        if (existingRefreshBtn) return;

        const refreshBtn = document.createElement('button');
        refreshBtn.id = 'refresh-cache-btn';
        refreshBtn.className = 'btn-outline mt-4';
        refreshBtn.innerHTML = '<i class="fa fa-refresh mr-2"></i>刷新缓存数据';

        const notificationDiv = document.createElement('div');
        notificationDiv.className = 'text-sm text-gray-500 mt-2';
        notificationDiv.textContent = '您正在查看缓存数据，点击上方按钮刷新';

        const container = document.createElement('div');
        container.className = 'col-span-full text-center';
        container.appendChild(refreshBtn);
        container.appendChild(notificationDiv);

        birdGallery.appendChild(container);

        refreshBtn.addEventListener('click', () => {
            refreshBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>刷新中...';
            fetchBirds(1, searchInput.value.toLowerCase().trim(), true);
        });
    }

    // 带缓存功能的 fetch 函数
    async function fetchWithCache(url, forceRefresh = false) {
        // 如果是无缓存模式，直接从网络获取
        if (!window.isServiceWorkerEnabled) {
            const response = await fetch(url, {
                cache: 'no-store'
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            return response;
        }

        const cache = await caches.open(CACHE_NAME);

        if (!forceRefresh) {
            const cachedResponse = await cache.match(url);
            if (cachedResponse) {
                return cachedResponse;
            }
        }

        try {
            const networkResponse = await fetch(url);

            if (networkResponse.ok) {
                // 克隆响应以同时存入缓存
                const responseToCache = networkResponse.clone();

                // 添加缓存时间元数据
                const responseData = await responseToCache.json();
                responseData.cacheTime = new Date().toISOString();

                // 创建新的可缓存响应
                const cacheResponse = new Response(JSON.stringify(responseData), {
                    headers: networkResponse.headers
                });

                await cache.put(url, cacheResponse);
            }

            return networkResponse;
        } catch (error) {
            // 如果网络请求失败，尝试返回缓存
            if (!forceRefresh) {
                const cachedResponse = await cache.match(url);
                if (cachedResponse) {
                    return cachedResponse;
                }
            }
            throw error;
        }
    }

    // 新增：更新加载更多按钮状态
    function updateLoadMoreButton(hasMore) {
        if (hasMore) {
            // 有更多数据时显示正常按钮
            loadMoreBtn.innerHTML = '<i class="fa fa-refresh mr-2"></i>加载更多';
            loadMoreBtn.disabled = false;
            loadMoreBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            // 没有更多数据时显示"到底了"
            loadMoreBtn.innerHTML = '<i class="fa fa-check mr-2"></i>到底了';
            loadMoreBtn.disabled = true;
            loadMoreBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }

    // 获取鸟类总数
    function fetchBirdCount() {
        fetch(`${API_BASE_URL}/birds/count`, {
            cache: 'no-store' // 禁用缓存
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('获取鸟类数量失败');
                }
                return response.json();
            })
            .then(data => {
                birdCountElement.textContent = data.type;
                imageCountElement.textContent = data.count;
            })
            .catch(error => {
                console.error('Error fetching bird count:', error);
                showNotification('获取鸟类数量失败');
            });
    }

    // 打开鸟类模态框
    function openBirdModal(mode, birdId = null) {
        currentBirdId = birdId;

        if (mode === 'add') {
            modalTitle.textContent = '上传夜鹭拟态图鉴';
            birdIdInput.value = '';
            birdForm.reset();
            removeImagePreview();
        } else if (mode === 'edit') {
            modalTitle.textContent = '编辑鸟类';

            fetch(`${API_BASE_URL}/birds/${birdId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('获取鸟类数据失败');
                    }
                    return response.json();
                })
                .then(bird => {
                    birdIdInput.value = bird.id;
                    birdNameInput.value = bird.name;

                    // 显示现有图片
                    if (bird.imageUrl) {
                        imagePreview.src = `${API_BASE_URL}/images/${bird.imageUrl}`;
                        imagePreviewContainer.classList.remove('hidden');
                        imageUploadArea.classList.add('hidden');
                    } else {
                        removeImagePreview();
                    }
                })
                .catch(error => {
                    console.error('Error fetching bird:', error);
                    showNotification('获取鸟类数据失败');
                    closeBirdModal();
                });
        }

        birdModal.classList.remove('hidden');
        setTimeout(() => {
            modalContent.classList.remove('scale-95', 'opacity-0');
            modalContent.classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    // 关闭鸟类模态框
    function closeBirdModal() {
        modalContent.classList.remove('scale-100', 'opacity-100');
        modalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            birdModal.classList.add('hidden');
            currentBirdId = null;
        }, 300);
    }

    // 处理图片上传
    function handleImageUpload(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (event) {
            imagePreview.src = event.target.result;
            imagePreviewContainer.classList.remove('hidden');
            imageUploadArea.classList.add('hidden');
        };
        reader.readAsDataURL(file);
    }

    // 移除图片预览
    function removeImagePreview() {
        birdImageInput.value = '';
        imagePreviewContainer.classList.add('hidden');
        imageUploadArea.classList.remove('hidden');
    }

    // 处理鸟类表单提交
    function handleBirdFormSubmit(e) {
        e.preventDefault();

        const operationType = currentBirdId ? 'update' : 'create';
        const isWithinLimit = checkOperationLimit(operationType);

        if (!isWithinLimit) {
            showNotification('您今天的操作次数已达上限（8次）');
            return;
        }

        const name = birdNameInput.value.trim();
        const imageFile = birdImageInput.files[0];

        // 前端验证
        if (!name) {
            showNotification('请输入鸟类名称');
            return;
        }
        if (name.length > 10) {
            showNotification('鸟类名称不能超过10个字符');
            return;
        }

        if (imageFile && imageFile.size > 1048576) {
            showNotification('图片大小不能超过1MB');
            return;
        }

        const formData = new FormData();
        formData.append('name', name);
        if (imageFile) formData.append('image', imageFile);

        let url, method, operationDesc;

        if (currentBirdId) {
            url = `${API_BASE_URL}/birds/${currentBirdId}`;
            method = 'PUT';
            operationDesc = `更新鸟类: ${name || '未命名'}`;
        } else {
            url = `${API_BASE_URL}/birds`;
            method = 'POST';
            operationDesc = `新增鸟类: ${name}`;
        }

        fetchWithLogging(url, method, formData, operationDesc)
            .then(data => {
                fetchBirds();
                fetchBirdCount();
                closeBirdModal();
                showNotification(currentBirdId ? '鸟类更新成功' : '鸟类添加成功');
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification(error.message || '操作失败');
            });
    }

    // 创建鸟类卡片
    function createBirdCard(bird) {
        const card = document.createElement('div');
        card.className = 'bird-card p-0.5 card-hover mb-1.5';
        card.setAttribute('data-id', bird.id);

        // 判断是否为管理员模式
        const isAdminMode = checkAdminMode(); // 假设存在一个检查管理员模式的函数

        // 创建图片容器
        const imgContainer = document.createElement('div');
        imgContainer.className = 'relative';

        // 创建图片元素
        const img = document.createElement('img');
        img.src = bird.imageUrl ? `${API_BASE_URL}/images/${bird.imageUrl}` : 'https://picsum.photos/seed/default/400/300';
        img.alt = bird.name;
        img.className = 'w-full h-full object-cover';

        // 图片加载完成后计算宽高比并设置容器和卡片样式
        function updateCardStyles() {
            const width = img.naturalWidth || 400; // 默认值以防未加载
            const height = img.naturalHeight || 300;
            const aspectRatio = width / height;

            // 重置卡片和容器样式
            card.style.width = '';
            card.style.height = '';
            imgContainer.style.width = '';
            imgContainer.style.height = '';
            imgContainer.style.maxWidth = '';
            imgContainer.style.margin = '';

            // 使用 window.innerWidth/Height 更准确反映可见区域
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            const screenAspectRatio = screenWidth / screenHeight;

            // 宽图：固定高度，限制宽度
            const isMobile = screenAspectRatio < 0.75 && screenWidth < 768;
            const containerHeight = isMobile ? 100 : 168;
            const containerWidth = containerHeight * aspectRatio;

            imgContainer.style.height = `${containerHeight}px`;
            imgContainer.style.width = `${containerWidth}px`;
            imgContainer.style.maxWidth = '100%';
            imgContainer.style.margin = '0 auto';
        }

        img.onload = updateCardStyles;

        // 错误处理
        img.onerror = function () {
            // 使用默认图片并应用相同的宽高比逻辑
            this.src = 'https://picsum.photos/seed/error/400/300';
            this.onload(); // 触发默认图片的加载事件
        };

        // 将图片添加到容器
        imgContainer.appendChild(img);

        // 设置卡片内容
        card.innerHTML = `
    <div class="p-1">
        <div class="flex ${isAdminMode ? 'justify-between' : 'justify-center'} items-center">
            <h3 class="font-bold text-lg md:text-l lg:text-2xl ${!isAdminMode ? 'text-center' : ''} leading-tight md:leading-relaxed">${bird.name}</h3>
            ${isAdminMode ? `
            <div class="flex space-x-2">
                <button class="bg-gray-100 p-2 cursor-pointer transition-all hover:bg-gray-200 edit-btn" data-id="${bird.id}">
                    <i class="fa fa-pencil text-primary"></i>
                </button>
                <button class="bg-gray-100 p-2 cursor-pointer transition-all hover:bg-gray-200 delete-btn" data-id="${bird.id}">
                    <i class="fa fa-trash-o text-red-500"></i>
                </button>
            </div>
            ` : ''}
        </div>
    </div>
    `;

        // 将图片容器插入到卡片开头
        card.insertBefore(imgContainer, card.firstChild);

        // 只有管理员模式下才添加按钮事件
        if (isAdminMode) {
            const editBtn = card.querySelector('.edit-btn');
            const deleteBtn = card.querySelector('.delete-btn');

            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const birdId = parseInt(e.currentTarget.getAttribute('data-id'));
                openBirdModal('edit', birdId);
            });

            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const birdId = parseInt(e.currentTarget.getAttribute('data-id'));
                deleteBird(birdId);
            });
        }

        // 使用防抖函数包装事件处理程序
        const debouncedUpdate = debounce(updateCardStyles, 150);

        // 监听屏幕方向变化和窗口大小调整
        window.addEventListener('resize', debouncedUpdate);
        window.addEventListener('orientationchange', debouncedUpdate);

        // 初始调用一次以设置样式
        if (img.complete) updateCardStyles();

        // 返回卡片元素
        return card;
    }

    // 示例：检查是否为管理员模式的函数（需根据实际情况实现）
    function checkAdminMode() {
        return window.isAdmin;
    }

    // 删除鸟类
    function deleteBird(birdId) {
        if (confirm('确定要删除这个鸟类吗？')) {
            const operationDesc = `删除鸟类: ID#${birdId}`;

            if (!checkOperationLimit('delete')) {
                showNotification('您今天的操作次数已达上限（8次）');
                return;
            }

            fetchWithLogging(`${API_BASE_URL}/birds/${birdId}`, 'DELETE', null, operationDesc)
                .then(() => {
                    fetchBirds();
                    fetchBirdCount();
                    showNotification('鸟类已删除');
                })
                .catch(error => {
                    console.error('Error deleting bird:', error);
                    showNotification('删除鸟类失败');
                });
        }
    }

    // 统一的带日志记录的fetch函数
    async function fetchWithLogging(url, method, body, operationDesc) {
        try {
            const response = await fetch(url, {
                method,
                body,
                headers: {
                    'X-Operation-Desc': encodeURIComponent(operationDesc)
                }
            });

            if (!response.ok) {
                if (response.status === 429) {
                    throw new Error('操作频率超限：单个IP 24小时内最多进行8次操作');
                }
                throw new Error('操作失败');
            }

            // 更新本地操作记录
            updateLocalOperationLog(operationDesc);

            return await response.json();
        } catch (error) {
            throw error;
        }
    }

    // 检查本地操作限制
    function checkOperationLimit(operationType) {
        const operations = JSON.parse(localStorage.getItem('birdOperations') || '[]');
        const today = new Date().toISOString().split('T')[0];
        const todayOperations = operations.filter(op => op.date === today);

        // 显示本地剩余操作次数（可选）
        const remaining = Math.max(0, 8 - todayOperations.length);
        console.log(`今日剩余操作次数: ${remaining}/8`);

        return todayOperations.length < 8;
    }

    // 更新本地操作日志
    function updateLocalOperationLog(operationDesc) {
        const operations = JSON.parse(localStorage.getItem('birdOperations') || '[]');
        const today = new Date().toISOString().split('T')[0];

        operations.push({
            timestamp: new Date().toISOString(),
            operation: operationDesc,
            date: today
        });

        // 保持最近7天的记录
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
        const recentOperations = operations.filter(op => {
            return new Date(op.timestamp) > oneWeekAgo;
        });

        localStorage.setItem('birdOperations', JSON.stringify(recentOperations));
    }

    // 处理滚动事件
    function handleScroll() {
        if (window.scrollY > 10) {
            // 分别添加和移除每个类
            navbar.classList.add('py-2');
            navbar.classList.remove('py-3');
        } else {
            // 分别添加和移除每个类
            navbar.classList.add('py-3');
            navbar.classList.remove('py-2');
        }
    }

    // 处理搜索
    function handleSearch() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        fetchBirds(1, searchTerm);
    }

    // 加载更多鸟类
    function loadMoreBirds() {
        if (isLoading || !hasMoreData) return;

        loadMoreBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>加载中...';

        fetchBirds(currentPage + 1, searchInput.value.toLowerCase().trim())
            .catch(error => {
                console.error('加载更多鸟类失败:', error);
                showNotification('加载更多鸟类失败');
                loadMoreBtn.innerHTML = '<i class="fa fa-refresh mr-2"></i>加载更多';
            });
    }

    // 显示通知
    function showNotification(message, type = 'info') {
        notification.textContent = message;

        // 重置所有样式类
        notification.className = 'fixed bottom-4 right-4 px-4 py-2 border-2 border-black p-4 transform transition-all duration-500 translate-y-20 opacity-0 z-50';

        // 根据类型添加样式
        switch (type) {
            case 'error':
                notification.classList.add('bg-red-500', 'text-white');
                break;
            case 'warning':
                notification.classList.add('bg-yellow-500', 'text-black');
                break;
            case 'success':
                notification.classList.add('bg-green-500', 'text-white');
                break;
            default:
                notification.classList.add('bg-primary', 'text-white');
        }

        notification.classList.remove('translate-y-20', 'opacity-0');

        setTimeout(() => {
            notification.classList.add('translate-y-20', 'opacity-0');
        }, 3000);
    }

    // 初始化页面
    init();
</script>
</body>
</html>
